@model OnlineLibrary.Web.Models.UserLoansViewModels.UserLoansViewModel

@{
    ViewBag.Title = "My Loans";
}

<h2>My Loans</h2>

<ul class="nav nav-tabs">
    <li>
        <a data-toggle="tab" href="#active">
            Active Loans
            <span id="activeLoansBadge" class="badge"></span>
        </a>
    </li>
    <li>
        <a data-toggle="tab" href="#requests">Requests
            <span id="requestsBage" class="badge"></span>
        </a>
    </li>
    <li><a data-toggle="tab" href="#history">History</a></li>
</ul>

<div class="tab-content">
    @* Active Loans Tabs. *@
    <div id="active" class="tab-pane fade">
        <p></p>
        <div class="row">
            <div class="col-sm-2"></div>
            <div class="col-sm-8">
                @* approved laons panel *@
                <div class="panel panel-default">
                    <div class="panel-heading">
                        <h3 class="panel-title">
                            <span class="glyphicon glyphicon-list-alt" aria-hidden="true"></span>
                            <strong>Active loans</strong>
                        </h3>
                    </div>

                    @foreach (var loan in Model.CurrentLoans)
                    {
                        if ((loan.ExpectedReturnDate.Value - DateTime.Now).Days > 5)
                        {
                            <div class="panel-body">
                                You have loaned <strong>"@loan.Title"</strong> and you are expected to return the book before <strong>@string.Format("{0:dddd, MMMM dd, yyyy}", loan.ExpectedReturnDate)</strong>
                            </div>
                        }
                    }
                </div>

                @* Soon expiring panel. *@
                <div class="panel panel-warning">
                    <div class="panel-heading">
                        <h3 class="panel-title">
                            <span class="glyphicon glyphicon-exclamation-sign" aria-hidden="true"></span>
                            <strong>Loans that expire soon</strong>
                        </h3>
                    </div>

                    @foreach (var loan in Model.CurrentLoans)
                    {
                        if ((loan.ExpectedReturnDate.Value - DateTime.Now).Days <= 5 && (loan.ExpectedReturnDate.Value - DateTime.Now).Days > 0)
                        {
                            <div class="panel-body">
                                You have loaned <strong>"@loan.Title"</strong> and you are expected to return the book before @string.Format("{0:dddd, MMMM dd, yyyy}", loan.ExpectedReturnDate)  - you have <strong>@((loan.ExpectedReturnDate.Value - DateTime.Now).Days) days left</strong>!
                            </div>
                        }
                    }
                </div>

                @* Overdue laons panel. *@
                <div class="panel panel-danger">
                    <div class="panel-heading">
                        <h3 class="panel-title">
                            <span class="glyphicon glyphicon-exclamation-sign" aria-hidden="true"></span>
                            <strong>Loans overdue</strong>
                        </h3>
                    </div>

                    @foreach (var loan in Model.CurrentLoans)
                    {
                        if ((loan.ExpectedReturnDate.Value - DateTime.Now).Days <= 0)
                        {
                            <div class="panel-body">
                                You have loaned <strong>"@loan.Title"</strong> and you are expected to return the book before @string.Format("{0:dddd, MMM d, yyyy}", loan.ExpectedReturnDate) - the return time is <strong>@((DateTime.Now - loan.ExpectedReturnDate.Value).Days) days overdue</strong>!
                            </div>
                        }
                    }
                </div>

            </div>
            <div class="col-sm-2"></div>
            <br />
        </div>
    </div>    
    
    @* Requests Tab. *@
    <div id="requests" class="tab-pane fade">
        <p></p>
        <div class="row">
            <div class="col-sm-2"></div>
            <div class="col-sm-8">

                @* Rejected requests Label *@
                <div class="panel panel-danger">
                    <div class="panel-heading">
                        <h3 class="panel-title">
                            <span class="glyphicon glyphicon-remove-sign" aria-hidden="true"></span>
                            <strong>Rejected requests</strong>
                        </h3>
                    </div>

                    @if (!Model.RejectedLoans.Any())
                    {
                        <div class="panel-body">
                            There are no rejected loan requests.
                        </div>
                    }
                    else
                    {
                        foreach (var loan in Model.RejectedLoans)
                        {
                            <div class="panel-body">
                                Your request for <strong> "@loan.Title" </strong> was rejected.
                            </div>
                        }
                    }
                </div>

                @* Approved requests panel. *@
                <div class="panel panel-success">
                    <div class="panel-heading">
                        <h3 class="panel-title">
                            <span class="glyphicon glyphicon-ok-sign" aria-hidden="true"></span>
                            <strong>Approved loan requests</strong>
                        </h3>
                    </div>
                    @if (!Model.ApprovedLoans.Any())
                    {
                        <div class="panel-body">
                            There are no approved loan requests.
                        </div>
                    }
                    else
                    {
                        foreach (var loan in Model.ApprovedLoans)
                        {
                            <div class="panel-body">
                                You have sent a loan request for the book <strong>"@loan.Title"</strong> - it was approved. You are expected to go to the library and take the book.
                                <br /><br />
                                @using (Html.BeginForm("CancelApprovedLoan", "UserLoans", new { id = loan.BookId }))
                                {
                                    <input type="submit" class="btn btn-danger" value="Cancel Loan" />
                                }
                            </div>
                        }
                    }
                </div>

                @* Pending loans label *@
                <div class="panel panel-warning">
                    <div class="panel-heading">
                        <h3 class="panel-title">
                            <span class="glyphicon glyphicon-time" aria-hidden="true"></span>
                            Pending loan requests
                        </h3>
                    </div>
                    @if (!Model.PendingLoans.Any())
                    {
                        <div class="panel-body">
                            You have no pending loans.
                        </div>
                    }
                    else
                    {
                        foreach (var loan in Model.PendingLoans)
                        {
                            <div class="panel-body">
                                Your loan request for <strong> "@loan.BookTitle" </strong> is pending confirmation.
                                <br /><br />
                                @using (Html.BeginForm("CancelPendingLoan", "UserLoans", new { id = loan.BookId }))
                                {
                                    <input type="submit" class="btn btn-danger" value="Cancel Loan" />
                                }
                            </div>
                        }
                    }
                </div>

            </div>
            <div class="col-sm-2"></div>
            <br />
        </div>
    </div>

    @* History Tab *@
    <div id="history" class="tab-pane fade">
        <p></p>
        <div class="row">
            <div class="col-sm-2"></div>
            <div class="col-sm-8">

                @* Returned books label*@
                <div class="panel panel-success">
                    <div class="panel-heading">
                        <h3 class="panel-title">
                            <span class="glyphicon glyphicon-ok-sign" aria-hidden="true"></span>
                            Returned books
                        </h3>
                    </div>

                    @if (!Model.ReturnedLoans.Any())
                    {
                        <div class="panel-body">
                            You have no returned books.
                        </div>
                    }
                    else
                    {
                        foreach (var loan in Model.ReturnedLoans)
                        {
                            <div class="panel-body">
                                You have loaned and returned the book <strong> "@loan.Title" </strong>.
                            </div>
                        }
                    }
                </div>

                @* Lost books label *@
                <div class="panel panel-danger">
                    <div class="panel-heading">
                        <h3 class="panel-title">
                            <span class="glyphicon glyphicon-question-sign" aria-hidden="true"></span>
                            Lost books
                        </h3>
                    </div>

                    @if (!Model.LostBooks.Any())
                    {
                        <div class="panel-body">
                            You have no lost books.
                        </div>
                    }
                    else
                    {
                        foreach (var loan in Model.LostBooks)
                        {
                            <div class="panel-body">
                                You have loaned and lost the book <strong> "@loan.Title" </strong>.
                            </div>
                        }
                    }
                </div>
            </div>
            <div class="col-sm-2"></div>
            <br />
        </div>
    </div>
</div>
@section scripts{
<script>
   
    $(document).ready(function ()
    {
        var activeLoansBageNumber = @Model.RejectedLoans.Count() + @Model.ApprovedLoans.Count();
        if (activeLoansBageNumber != 0) 
        {
            $("#activeLoansBadge").text(activeLoansBageNumber);
        }
        else
        {
            $("#activeLoansBadge").text("");
        }
       
    });


</script>
}